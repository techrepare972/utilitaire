<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>Fiche de Prise en Charge - TechPrecision</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <style>
    body { font-family: 'Poppins', sans-serif; background-color: #f0f2f5; }
    .modal { transition: opacity 0.3s ease; }
    #signature-pad { border: 1px solid #e2e8f0; border-radius: 8px; background-color: #fff; touch-action: none; }
  </style>
  <!-- Libs -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/signature_pad/1.5.3/signature_pad.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body class="text-gray-800">
  <div class="container mx-auto p-4 md:p-8">
    <!-- HEADER -->
    <header class="flex flex-col md:flex-row justify-between items-center mb-8">
      <div class="flex items-center space-x-3 mb-4 md:mb-0">
        <!-- Chemin logo corrigé -->
        <img id="header-logo" src="logo.png" alt="Logo Tech Precision" class="h-10 w-10" />
        <h1 class="text-3xl font-bold text-gray-800">Fiche de Prise en Charge</h1>
      </div>
    </header>

    <!-- FORM -->
    <div id="intakeContent" class="p-6 bg-white rounded-xl shadow-md">
      <h2 class="text-2xl font-bold mb-6">Détails de la prise en charge</h2>
      <form id="intakeForm" class="space-y-6">
        <div>
          <label for="intakeClientName" class="block text-sm font-medium text-gray-700">Nom du client</label>
          <input type="text" id="intakeClientName" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-3" />
        </div>
        <div>
          <label for="intakePhoneNumber" class="block text-sm font-medium text-gray-700">Numéro de téléphone</label>
          <input type="tel" id="intakePhoneNumber" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-3" />
        </div>
        <div>
          <label for="intakeEquipment" class="block text-sm font-medium text-gray-700">Équipement</label>
          <input type="text" id="intakeEquipment" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-3" />
        </div>
        <div>
          <label for="intakeBrand" class="block text-sm font-medium text-gray-700">Marque</label>
          <input type="text" id="intakeBrand" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-3" />
        </div>
        <div>
          <label for="intakeProblem" class="block text-sm font-medium text-gray-700">Problème</label>
          <textarea id="intakeProblem" rows="4" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-3"></textarea>
        </div>
        <div>
          <label for="intakePhoto" class="block text-sm font-medium text-gray-700">Photo de l'équipement</label>
          <input
            type="file"
            id="intakePhoto"
            accept="image/*"
            capture="environment"
            class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100"
          />
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Signature du client</label>
          <canvas id="signature-pad" class="w-full h-40 bg-gray-50 border border-gray-300 rounded-lg"></canvas>
          <button type="button" id="clearSignatureBtn" class="mt-2 text-xs text-red-500 hover:text-red-700">Effacer la signature</button>
        </div>
        <div class="flex justify-end space-x-4 pt-4">
          <button type="button" id="saveIntakeBtn" class="bg-indigo-600 text-white font-bold py-3 px-6 rounded-lg shadow-lg hover:bg-indigo-700 transition">
            Générer le PDF
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- ALERT -->
  <div id="customAlertModal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden">
    <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-sm text-center transform transition-all scale-95 opacity-0">
      <h3 class="text-xl font-bold mb-4">Notification</h3>
      <p id="alertMessage" class="text-gray-700 mb-6"></p>
      <button id="closeAlertBtn" class="bg-indigo-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-indigo-700 transition">Fermer</button>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // DOM
      const intakeForm = document.getElementById('intakeForm');
      const saveIntakeBtn = document.getElementById('saveIntakeBtn');
      const signaturePadCanvas = document.getElementById('signature-pad');
      const clearSignatureBtn = document.getElementById('clearSignatureBtn');
      const intakePhoto = document.getElementById('intakePhoto');

      // Alert
      const customAlertModal = document.getElementById('customAlertModal');
      const alertMessage = document.getElementById('alertMessage');
      const closeAlertBtn = document.getElementById('closeAlertBtn');
      const openCustomAlertModal = (message) => {
        alertMessage.textContent = message;
        customAlertModal.classList.remove('hidden');
        setTimeout(() => {
          customAlertModal.classList.remove('opacity-0');
          const box = customAlertModal.querySelector('div');
          box.classList.remove('scale-95', 'opacity-0');
          box.classList.add('scale-100', 'opacity-100');
        }, 10);
      };
      closeAlertBtn.addEventListener('click', () => {
        const box = customAlertModal.querySelector('div');
        box.classList.add('scale-95', 'opacity-0');
        box.classList.remove('scale-100', 'opacity-100');
        customAlertModal.classList.add('opacity-0');
        setTimeout(() => customAlertModal.classList.add('hidden'), 300);
      });

      // Signature Pad (DPR aware)
      const signaturePad = new SignaturePad(signaturePadCanvas, { penColor: '#111827' });
      const resizeSignatureCanvas = () => {
        const ratio = Math.max(window.devicePixelRatio || 1, 1);
        const data = signaturePad.toData();
        signaturePadCanvas.width = signaturePadCanvas.offsetWidth * ratio;
        signaturePadCanvas.height = signaturePadCanvas.offsetHeight * ratio;
        signaturePadCanvas.getContext('2d').scale(ratio, ratio);
        signaturePad.fromData(data);
      };
      window.addEventListener('resize', resizeSignatureCanvas);
      resizeSignatureCanvas();
      clearSignatureBtn.addEventListener('click', () => signaturePad.clear());

      // Image utils
      const getImageFormatFromDataUrl = (dataUrl) => {
        if (!dataUrl) return 'JPEG';
        if (dataUrl.startsWith('data:image/png')) return 'PNG';
        if (dataUrl.startsWith('data:image/jpeg') || dataUrl.startsWith('data:image/jpg')) return 'JPEG';
        return 'JPEG';
      };

      // Convertit tout fichier image en DataURL JPEG compressé (compat iOS/Android, HEIC -> JPEG)
      const fileToCompressedJpegDataUrl = (file, maxDim = 1600, quality = 0.85) =>
        new Promise((resolve, reject) => {
          if (!file) return resolve(null);
          const url = URL.createObjectURL(file);
          const img = new Image();
          img.onload = () => {
            try {
              const { width, height } = img;
              let targetW = width, targetH = height;
              if (Math.max(width, height) > maxDim) {
                const scale = maxDim / Math.max(width, height);
                targetW = Math.round(width * scale);
                targetH = Math.round(height * scale);
              }
              const canvas = document.createElement('canvas');
              canvas.width = targetW;
              canvas.height = targetH;
              const ctx = canvas.getContext('2d');
              ctx.drawImage(img, 0, 0, targetW, targetH);
              const jpegDataUrl = canvas.toDataURL('image/jpeg', quality);
              URL.revokeObjectURL(url);
              resolve(jpegDataUrl);
            } catch (err) {
              URL.revokeObjectURL(url);
              reject(err);
            }
          };
          img.onerror = (e) => {
            URL.revokeObjectURL(url);
            reject(e);
          };
          img.src = url;
        });

      // Chargement image (logo) -> HTMLImageElement
      const loadImage = (src) =>
        new Promise((resolve, reject) => {
          const img = new Image();
          img.onload = () => resolve(img);
          img.onerror = reject;
          img.src = src;
        });

      // Clic: génération PDF (avec pré-ouverture fenêtre iOS/Safari)
      saveIntakeBtn.addEventListener('click', async (e) => {
        e.preventDefault();

        const clientName = document.getElementById('intakeClientName').value.trim();
        const phoneNumber = document.getElementById('intakePhoneNumber').value.trim();
        const equipment = document.getElementById('intakeEquipment').value.trim();
        const brand = document.getElementById('intakeBrand').value.trim();
        const problem = document.getElementById('intakeProblem').value.trim();
        const photoFile = intakePhoto.files[0];
        const signatureData = signaturePad.isEmpty() ? null : signaturePad.toDataURL('image/png');

        if (!clientName || !equipment || !problem || signaturePad.isEmpty()) {
          openCustomAlertModal("Veuillez remplir le nom du client, l'équipement, le problème et la signature.");
          return;
        }

        // Détection
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) ||
                      (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
        const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);

        // Pré-ouvrir la fenêtre dans le même geste utilisateur
        const preOpenedWin = (isIOS || isSafari) ? window.open('about:blank', '_blank') : null;

        // Photo -> JPEG compressé (évite HEIC/HEIF et gros fichiers)
        let photoDataUrl = null;
        try {
          if (photoFile) {
            photoDataUrl = await fileToCompressedJpegDataUrl(photoFile, 1600, 0.85);
          }
        } catch (error) {
          console.error('Erreur conversion photo:', error);
          if (preOpenedWin && !preOpenedWin.closed) {
            preOpenedWin.document.write('<p style="font-family:system-ui">Erreur lors du traitement de la photo (format non supporté).</p>');
          }
          openCustomAlertModal('Erreur lors du traitement de la photo (format non supporté). Réessayez avec une image JPEG/PNG.');
          return;
        }

        const intakeData = { clientName, phoneNumber, equipment, brand, problem, photoDataUrl, signatureData };

        openCustomAlertModal('Génération du PDF…');
        try {
          await generateIntakePdf(intakeData, { preOpenedWin });
          intakeForm.reset();
          signaturePad.clear();
          openCustomAlertModal('PDF généré. Il devrait s’ouvrir ou se télécharger selon votre appareil.');
        } catch (err) {
          console.error('Erreur PDF:', err);
          if (preOpenedWin && !preOpenedWin.closed) {
            preOpenedWin.document.write('<p style="font-family:system-ui">Erreur lors de la génération du PDF.</p>');
          }
          openCustomAlertModal('Une erreur est survenue lors de la génération du PDF. Réessayez.');
        }
      });

      // Génération PDF
      async function generateIntakePdf(data, { preOpenedWin = null } = {}) {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({ unit: 'mm', format: 'a4' });

        // --- Header avec logo (optionnel) ---
        let logoImgEl = null;
        try {
          logoImgEl = await loadImage('logo.png'); // chemin corrigé
        } catch (_) {
          logoImgEl = null; // continue sans logo
        }
        const pageWidth = doc.internal.pageSize.getWidth();

        doc.setFont('helvetica', 'bold');
        doc.setFontSize(22);
        doc.text('Prise en charge matériel', pageWidth / 2, 20, { align: 'center' });

        if (logoImgEl) {
          const logoWidth = 20;
          const logoHeight = (logoImgEl.height * logoWidth) / logoImgEl.width;
          doc.addImage(logoImgEl, 'PNG', 10, 12, logoWidth, logoHeight);
        }

        doc.setFontSize(10);
        doc.text(`Tech Precision - Rapport du ${new Date().toLocaleDateString('fr-FR')}`, pageWidth / 2, 30, { align: 'center' });
        doc.line(10, 35, 200, 35);

        // --- Corps ---
        let y = 45;
        doc.setFontSize(12);
        doc.setFont('helvetica', 'normal');
        doc.text(`Nom du client: ${data.clientName}`, 10, y);
        doc.text(`Téléphone: ${data.phoneNumber || 'N/A'}`, 10, (y += 7));
        doc.text(`Équipement: ${data.equipment}`, 10, (y += 7));
        doc.text(`Marque: ${data.brand || 'N/A'}`, 10, (y += 7));
        doc.text(`Problème:`, 10, (y += 7));
        const problemLines = doc.splitTextToSize(data.problem || 'N/A', 180);
        doc.text(problemLines, 10, (y += 5));
        y += problemLines.length * 5;
        y = Math.max(y, 100);

        // --- Photo ---
        const photoFrameWidth = 85;
        const photoFrameHeight = 60;
        doc.setFont('helvetica', 'bold');
        doc.text("Photo de l'équipement:", 10, (y += 10));
        doc.setFont('helvetica', 'normal');
        doc.rect(10, y + 5, photoFrameWidth, photoFrameHeight, 'S');

        if (data.photoDataUrl) {
          try {
            // Charger pour dimensions
            const imgEl = await loadImage(data.photoDataUrl);
            const imgRatio = imgEl.width / imgEl.height;
            const frameRatio = photoFrameWidth / photoFrameHeight;
            let finalW, finalH;
            if (imgRatio > frameRatio) {
              finalW = photoFrameWidth;
              finalH = photoFrameWidth / imgRatio;
            } else {
              finalH = photoFrameHeight;
              finalW = photoFrameHeight * imgRatio;
            }
            const imgX = 10 + (photoFrameWidth - finalW) / 2;
            const imgY = y + 5 + (photoFrameHeight - finalH) / 2;

            // Photo convertie en JPEG -> format garanti
            doc.addImage(data.photoDataUrl, 'JPEG', imgX, imgY, finalW, finalH);
          } catch (e) {
            doc.text('Erreur photo', 10 + photoFrameWidth / 2, y + 5 + photoFrameHeight / 2, { align: 'center' });
          }
        } else {
          doc.text('Pas de photo', 10 + photoFrameWidth / 2, y + 5 + photoFrameHeight / 2, { align: 'center' });
        }

        y += photoFrameHeight + 20;

        // --- Signature ---
        doc.setFont('helvetica', 'bold');
        doc.text('Signature du client:', 10, y);
        doc.setFont('helvetica', 'normal');

        const sigWidth = 80;
        const sigHeight = 30;
        if (y + 5 + sigHeight > 280) {
          doc.addPage();
          y = 20;
        }
        doc.rect(10, y + 5, sigWidth, sigHeight, 'S');

        if (data.signatureData) {
          const sigFmt = getImageFormatFromDataUrl(data.signatureData); // normalement PNG
          doc.addImage(data.signatureData, sigFmt, 10, y + 5, sigWidth, sigHeight);
        } else {
          doc.text('Pas de signature fournie.', 10, y + 5);
        }

        // --- Sortie PDF (compat iOS/Android) ---
        const filename = `Prise_en_charge_${data.clientName.replace(/\s+/g, '_')}.pdf`;
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) ||
                      (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
        const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);

        if (isIOS || isSafari) {
          const blob = doc.output('blob');
          const url = URL.createObjectURL(blob);

          if (preOpenedWin && !preOpenedWin.closed) {
            preOpenedWin.location.href = url; // même geste utilisateur → pas bloqué
          } else {
            // Fallback si la pré-ouverture a été bloquée
            const win = window.open(url, '_blank');
            if (!win) {
              const a = document.createElement('a');
              a.href = url;
              a.target = '_blank';
              a.rel = 'noopener';
              a.click();
            }
          }
        } else {
          // Android/desktop → téléchargement classique
          doc.save(filename);
        }
      }
    });
  </script>
</body>
</html>
