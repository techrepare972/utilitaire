document.addEventListener('DOMContentLoaded', () => {
    const appContainer = document.getElementById('app-container');
    const modal = document.getElementById('modal');
    const modalContent = document.getElementById('modal-content');
    const closeModalBtn = document.getElementById('close-modal');
    const backButton = document.getElementById('back-button');

    // Vos liens sont ici
    const googleFormsLink = "https://forms.gle/MWtNaPYrcdne9q1Z9";
    const whatsappBaseLink = "https://wa.me/596696600814"; // Ceci est le lien de base pour le num√©ro (CORRECTION: Renomm√© pour plus de clart√©)
    const phoneNumber = "+596696600814";

    let ticketNumber = ""; // D√©clarer ticketNumber globalement pour qu'il soit accessible (CORRECTION)

    // Fonction pour g√©n√©rer un num√©ro de ticket al√©atoire
    function generateTicketNumber() {
        const number = Math.floor(100 + Math.random() * 900);
        return `TP972-${number}`;
    }
    
    // ... (le reste de votre code CSS et HTML est le m√™me) ...

    // Fonction pour g√©n√©rer un nombre de personnes al√©atoire pour le compteur
    function generateUserCount() {
        return Math.floor(1000 + Math.random() * 9000);
    }

    // Donn√©es pour les probl√®mes Windows
    // ... (vos objets windowsProblems et macProblems sont les m√™mes) ...
    const windowsProblems = { /* ... */ };
    const macProblems = { /* ... */ };

    let currentProblems = {};

    // Fonction pour afficher la page de s√©lection du syst√®me d'exploitation
    function showOSSelection() {
        // ... (votre code pour showOSSelection est le m√™me) ...
        const userCount = generateUserCount();
        appContainer.innerHTML = `
            <div class="flex items-center justify-center mb-4">
                <img src="logo.png.png" alt="TECHPRECISION972 Logo" class="w-23 h-23 mb-2">
            </div>
            <h2 class="text-2xl font-bold text-gray-700 mb-2">TECHPRECISION972</h2>
            <h1 class="text-4xl font-bold text-gray-800 mb-2">Quel syst√®me utilisez-vous ?</h1>
            <p class="text-gray-600 mb-8">
                S√©lectionnez la marque de votre appareil pour obtenir des conseils sur mesure.
            </p>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div data-os="windows" class="card-hover cursor-pointer p-8 bg-blue-100 rounded-2xl shadow-md transition-all duration-300 transform">
                    <div class="text-6xl mb-4">ü™ü</div>
                    <h3 class="text-xl font-bold text-blue-800">Ordinateur Windows</h3>
                </div>
                <div data-os="mac" class="card-hover cursor-pointer p-8 bg-gray-100 rounded-2xl shadow-md transition-all duration-300 transform">
                    <div class="text-6xl mb-4">üçè</div>
                    <h3 class="text-xl font-bold text-gray-800">Ordinateur Mac</h3>
                </div>
            </div>
            <p class="text-sm text-gray-400 mt-6">
                Vous √™tes la **${userCount}**e personne √† utiliser l'utilitaire.
            </p>
        `;
    }

    // Fonction pour afficher la liste des probl√®mes pour le syst√®me choisi
    function showProblemList(os) {
        // ... (votre code pour showProblemList est le m√™me) ...
        if (os === 'windows') {
            currentProblems = windowsProblems;
        } else if (os === 'mac') {
            currentProblems = macProblems;
        }

        let cardsHtml = '';
        for (const key in currentProblems) {
            if (currentProblems.hasOwnProperty(key)) {
                const problem = currentProblems[key];
                const icon = {
                    'no-power': 'üíª',
                    'password-forgotten': 'üîë',
                    'battery-not-charging': 'üîã',
                    'dark-screen': 'üí°',
                    'slow-computer': 'üêå',
                    'wifi-down': 'üì∂',
                    'input-device-fail': 'üñ±Ô∏è',
                    'other-problem': 'ü§∑'
                }[key];
                const bgColor = {
                    'no-power': 'bg-purple-100',
                    'password-forgotten': 'bg-blue-100',
                    'battery-not-charging': 'bg-green-100',
                    'dark-screen': 'bg-yellow-100',
                    'slow-computer': 'bg-red-100',
                    'wifi-down': 'bg-orange-100',
                    'input-device-fail': 'bg-pink-100',
                    'other-problem': 'bg-gray-200'
                }[key];
                const textColor = {
                    'no-power': 'text-purple-800',
                    'password-forgotten': 'text-blue-800',
                    'battery-not-charging': 'text-green-800',
                    'dark-screen': 'text-yellow-800',
                    'slow-computer': 'text-red-800',
                    'wifi-down': 'text-orange-800',
                    'input-device-fail': 'text-pink-800',
                    'other-problem': 'text-gray-800'
                }[key];

                cardsHtml += `
                    <div data-problem="${key}" class="card-hover cursor-pointer p-6 ${bgColor} rounded-2xl shadow-md transition-all duration-300 transform">
                        <div class="text-3xl mb-2">${icon}</div>
                        <h3 class="text-lg font-semibold ${textColor}">${problem.title}</h3>
                    </div>
                `;
            }
        }

        appContainer.innerHTML = `
            <div class="flex items-center justify-between mb-4">
                <button id="back-to-os" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-full font-semibold hover:bg-gray-300 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-4 h-4 inline-block mr-1">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5L3 12m0 0l7.5-7.5M3 12h18" />
                    </svg>
                    Retour
                </button>
            </div>
            <div class="flex items-center justify-center mb-4">
                <img src="logo.png.png" alt="TECHPRECISION972 Logo" class="w-25 h-25 mb-2">
            </div>
            <h2 class="text-2xl font-bold text-gray-700 mb-2">TECHPRECISION972</h2>
            <h1 class="text-4xl font-bold text-gray-800 mb-2">Quel soucis rencontrez-vous ?</h1>
            <p class="text-gray-600 mb-8">
                S√©lectionnez votre probl√®me pour obtenir des √©tapes de d√©pannage simples et rapides.
            </p>
            <div id="problems-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                ${cardsHtml}
            </div>
        `;

        // Attache les √©couteurs d'√©v√©nements aux nouvelles cartes et au bouton de retour
        document.getElementById('problems-container').addEventListener('click', handleProblemClick);
        document.getElementById('back-to-os').addEventListener('click', showOSSelection);
    }

    // G√®re le clic sur un probl√®me
    function handleProblemClick(event) {
        let card = event.target.closest('[data-problem]');
        if (card) {
            const problemKey = card.dataset.problem;
            const problemData = currentProblems[problemKey];
            ticketNumber = generateTicketNumber(); // Assigner le ticketNumber √† la variable globale (CORRECTION)

            if (problemData) {
                let contentHTML = `
                    <div class="text-left mb-6 p-4 bg-gray-100 rounded-xl">
                        <p class="text-sm font-semibold text-gray-500">Votre num√©ro de ticket :</p>
                        <div class="flex items-center justify-between">
                            <p id="ticket-number-display" class="text-3xl font-bold text-gray-800">${ticketNumber}</p>
                            <button id="copy-ticket" class="text-gray-400 hover:text-gray-600 transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v-.938c0-.621-.52-1.125-1.164-1.125h-5.316a1.125 1.125 0 01-1.164-1.125v-1.077a.896.896 0 00-.896-.896h-1.077a1.125 1.125 0 01-1.125-1.125V9.071m9.67-4.485c.622 0 1.126.504 1.126 1.126V15.54L17.75 17.25h-.938m-7.25-2.25H9.071c-.622 0-1.126.504-1.126 1.126v1.492m9.67-4.485V6.75h-2.164a1.125 1.125 0 01-1.164-1.125V4.5m-5.316-2.25v-1.077a.896.896 0 00-.896-.896h-1.077A1.125 1.125 0 014.5 4.071v2.164" />
                                </svg>
                            </button>
                        </div>
                        <p class="text-sm text-gray-600 mt-2">
                            Veuillez noter ce num√©ro ou le copier pour un suivi plus rapide.
                        </p>
                    </div>
                    <h2 class="text-2xl font-bold mb-4 text-gray-800">${problemData.title}</h2>
                `;
                
                // Afficher les √©tapes seulement si le probl√®me en a
                if (problemData.steps.length > 0) {
                    contentHTML += '<ul class="list-disc list-inside space-y-2 text-left text-gray-700">';
                    problemData.steps.forEach(step => {
                        contentHTML += `<li>${step}</li>`;
                    });
                    contentHTML += '</ul>';
                }
                
                // Message final avec les liens de contact
                // Ces variables sont maintenant initialis√©es DANS la fonction, apr√®s que ticketNumber soit d√©fini (CORRECTION)
                const prefilledWhatsappText = `Bonjour, je vous contacte suite √† un probl√®me informatique. Mon num√©ro de ticket est : ${ticketNumber}.`;
                const prefilledWhatsappLink = `${whatsappBaseLink}&text=${encodeURIComponent(prefilledWhatsappText)}`; // Utilisez whatsappBaseLink (CORRECTION)
                const googleFormsFinalLink = `${googleFormsLink}`;

                contentHTML += `
                    <p class="mt-8 text-lg font-semibold text-gray-800">
                        Le probl√®me persiste ? Ne vous inqui√©tez pas !
                    </p>
                    <p class="text-sm text-gray-600 mb-4">
                        Remplissez notre formulaire, contactez-nous via WhatsApp ou appelez-nous directement pour une assistance personnalis√©e.
                    </p>
                    <div class="flex flex-col sm:flex-row justify-center items-center space-y-4 sm:space-y-0 sm:space-x-4 mt-6">
                        <a href="${googleFormsFinalLink}" target="_blank" class="contact-link bg-purple-600 text-white hover:bg-purple-700">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path d="M7 3a1 1 0 000 2h6a1 1 0 100-2H7zM5 7a1 1 0 011-1h8a1 1 0 110 2H6a1 1 0 01-1-1zM5 11a1 1 0 011-1h8a1 1 0 110 2H6a1 1 0 01-1-1zM9 15a1 1 0 011-1h4a1 1 0 110 2h-4a1 1 0 01-1-1z" />
                            </svg>
                            Formulaire
                        </a>
                        <a href="${prefilledWhatsappLink}" target="_blank" class="contact-link bg-green-500 text-white hover:bg-green-600">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12 0c-6.627 0-12 5.373-12 12s5.373 12 12 12 12-5.373 12-12-5.373-12-12-12zm-2.094 17.519c-.482-.093-2.883-1.189-3.292-1.336-.263-.09-.504-.148-.716.326-.201.442-.647 1.76-1.025 1.904-.325.127-.638.257-.962.22-.32-.036-.707-.15-.707-.492 0-.274.341-.409 1.144-1.294 1.157-1.123 2.502-2.527 2.657-2.735.155-.208.05-.333-.102-.478-.155-.144-.338-.285-.504-.424-.16-.134-.33-.314-.24-.515.09-.2.686-1.638.966-2.316.28-.679.564-.61.849-.61s.579-.047.884-.047c.299 0 .385.127.487.359.102.232.355.859.458 1.071.102.212.172.247.319.46.147.213.916 1.503.916 1.836 0 .333-.357.519-.357.519-.395.201-.637.31-.914.457-.277.146-.615.421-.357.734.258.312.984 1.439 1.258 1.636.273.197.358.319.461.431.103.111.106.182.072.348-.035.166-.46.862-.573 1.092-.112.23-.223.359-.446.471-.223.112-.497.165-.91.077z"/>
                            </svg>
                            WhatsApp
                        </a>
                        <a href="tel:${phoneNumber}" class="contact-link bg-slate-600 text-white hover:bg-slate-700">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M16.996 14.869c-.838-.052-.102-.782-.479-.933-.49-.193-.727-.221-1.229-.221-1.079 0-1.896-.549-2.617-1.272-.72-1.23-1.282-2.639-1.282-3.834 0-.498.028-.739.221-1.229.15-.377.88-.661.933-.479.839.052.102.782.479.933.49.193.727.221 1.229.221 1.079 0 1.896.549 2.617 1.272.72 1.23 1.282 2.639 1.282 3.834 0 .498-.028.739-.221 1.229-.15.377-.88.661-.933.479zM12 0c-6.627 0-12 5.373-12 12s5.373 12 12 12 12-5.373 12-12-5.373-12-12-12zm2.094 17.519c-.482-.093-2.883-1.189-3.292-1.336-.263-.09-.504-.148-.716.326-.201.442-.647 1.76-1.025 1.904-.325.127-.638.257-.962.22-.32-.036-.707-.15-.707-.492 0-.274.341-.409 1.144-1.294 1.157-1.123 2.502-2.527 2.657-2.735.155-.208.05-.333-.102-.478-.155-.144-.338-.285-.504-.424-.16-.134-.33-.314-.24-.515.09-.2.686-1.638.966-2.316.28-.679.564-.61.849-.61s.579-.047.884-.047c.299 0 .385.127.487.359.102.232.355.859.458 1.071.102.212.172.247.319.46.147.213.916 1.503.916 1.836 0 .333-.357.519-.357.519-.395.201-.637.31-.914.457-.277.146-.615.421-.357.734.258.312.984 1.439 1.258 1.636.273.197.358.319.461.431.103.111.106.182.072.348-.035.166-.46.862-.573 1.092-.112.23-.223.359-.446.471-.223.112-.497.165-.91.077z"/>
                            </svg>
                            Appeler
                        </a>
                    </div>
                `;

                modalContent.innerHTML = contentHTML;
                modal.classList.add('is-active'); // Affiche la modale
                
                // Ajoute la fonction de copie apr√®s que le contenu soit inject√©
                document.getElementById('copy-ticket').addEventListener('click', () => {
                    const ticketNumberText = document.getElementById('ticket-number-display').textContent;
                    navigator.clipboard.writeText(ticketNumberText).then(() => {
                        // Vous pouvez ajouter un feedback visuel ici si vous le souhaitez, par ex. un petit message "Copi√© !"
                    });
                });
            }
        }
    }

    // ... (le reste de votre gestion d'√©v√©nements est le m√™me) ...
    appContainer.addEventListener('click', (event) => {
        let osCard = event.target.closest('[data-os]');
        if (osCard) {
            showProblemList(osCard.dataset.os);
        }
    });

    // √âcouteur d'√©v√©nement pour fermer la modale
    closeModalBtn.addEventListener('click', () => {
        modal.classList.remove('is-active');
    });
    
    // √âcouteur pour le bouton "Retour"
    backButton.addEventListener('click', () => {
        modal.classList.remove('is-active');
    });

    // Ferme la modale si l'utilisateur clique en dehors
    modal.addEventListener('click', (event) => {
        if (event.target === modal) {
            modal.classList.remove('is-active');
        }
    });

    // Affiche la page de s√©lection de l'OS au chargement
    showOSSelection();
});
